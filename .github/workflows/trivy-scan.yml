name: Trivy Scan

on:
  push:
  workflow_dispatch:
    inputs:
      ITEM:
        description: "The item of trivy scan (e.g. KubeBlocks)"
        type: string
        required: false
        default: ''
      IMAGES:
        description: "The images of trivy scan (e.g. docker.io/apecloud/kubeblocks:latest)"
        type: string
        required: true
        default: ''
      APECD_REF:
        description: "The branch name of apecloud-cd"
        type: string
        required: false
        default: 'main'
  workflow_call:
    inputs:
      ITEM:
        description: "The item of trivy scan (e.g. KubeBlocks)"
        type: string
        required: false
        default: ''
      IMAGES:
        description: "The images of trivy scan (e.g. docker.io/apecloud/kubeblocks:latest)"
        type: string
        required: true
        default: ''
      APECD_REF:
        description: "The branch name of apecloud-cd"
        type: string
        required: false
        default: 'main'
    outputs:
      total-vulnerabilities:
        description: "trivy scan total vulnerabilities"
        value: ${{ jobs.trivy-scan.outputs.total-vulnerabilities }}

env:
  GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

jobs:
  trivy-scan:
    name: trivy-scan-${{ inputs.ITEM }}
    runs-on: ubuntu-latest
    outputs:
      total-vulnerabilities: ${{ steps.trivy-scan.outputs.total_vulnerabilities }}
    steps:
      - name: Checkout apecloud-cd Code
        uses: actions/checkout@v4
        with:
          repository: apecloud/apecloud-cd
          path: ./apecloud-cd
          ref: ${{ inputs.APECD_REF }}

      - name: Install Trivy
        uses: aquasecurity/setup-trivy@v0.2.3
        with:
          version: v0.63.0
          cache: true

      - name: Run Trivy vulnerability scanner
        id: trivy-scan
        shell: bash
        run: |
          IMAGES="${{ inputs.IMAGES }}"
          IMAGES="apecloud/kubeblocks:1.0.0|apecloud/kubeblocks-tools:1.0.0|apecloud/kubeblocks-dataprotection:1.0.0|apecloud/kubeblocks-charts:1.0.0"
          index=0
          for image in $(echo "${IMAGES}" | sed 's/|/ /g'); do
              index=$((index+1))
              echo "trivy image ${image}"
              trivy_scan_cmd="trivy image --format table --severity CRITICAL,HIGH --ignore-unfixed --output trivy_scan_report_${index}.out"
              if [[ $index -eq 1 ]]; then
                  eval "$trivy_scan_cmd ${image}"
              else
                  eval "$trivy_scan_cmd --skip-db-update --quiet ${image}" &
              fi
              sleep 1
          done
          wait
          TOTAL_VULNERABILITIES=""
          touch trivy_scan_report.out
          index=0
          for image in $(echo "${IMAGES}" | sed 's/|/ /g'); do
              index=$((index+1))
              trivy_scan_report="trivy_scan_report_${index}.out"
              if [[ -f "${trivy_scan_report}" ]]; then
                  check_vulnerabilities=$(cat "${trivy_scan_report}" | (grep "Total:" |egrep "CRITICAL|HIGH" || true) )
                  if [[ -n "${check_vulnerabilities}" ]]; then
                      echo "❌ $(tput -T xterm setaf 1)${image} has CRITICAL or HIGH vulnerabilities$(tput -T xterm sgr0)"
                      high_total=0
                      critical_total=0
                      grep "Total:" ${trivy_scan_report} | egrep "CRITICAL|HIGH" | while read -r line; do
                          high=$(echo "$line" | awk -F'[(): ]+' '{for(i=1;i<=NF;i++){if($i == "HIGH") high=$(i+1)} } END{print high+0}')
                          critical=$(echo "$line" | awk -F'[(): ]+' '{for(i=1;i<=NF;i++){if($i == "CRITICAL") crit=$(i+1)} } END{print crit+0}')
                          high_total=$((high_total + high))
                          critical_total=$((critical_total + critical))
                      done
                      total_total=$((high_total + critical_total))
                      vulnerabilities_total="Total: $total_total (HIGH: $high_total, CRITICAL: $critical_total)"
                      echo "${vulnerabilities_total}"
                      
                      CI_JOB_URL=$(bash ${{ github.workspace }}/apecloud-cd/.github/utils/utils.sh \
                          --type 44 \
                          --github-repo "${{ github.repository }}" \
                          --github-token "${{ env.GH_TOKEN }}" \
                          --run-id "$GITHUB_RUN_ID" \
                          --test-result "trivy-scan-${{ inputs.ITEM }}")
                      echo "CI_JOB_URL:"${CI_JOB_URL}
          
                      TOTAL_VULNERABILITIES="${TOTAL_VULNERABILITIES}##${{ inputs.ITEM }}|${image}|${critical_total}|${high_total}|${CI_JOB_URL}"
                  else
                      echo "✅ $(tput -T xterm setaf 2)${image} has no CRITICAL or HIGH vulnerabilities$(tput -T xterm sgr0)"
                  fi
          
                  echo "====================================================================== ${image} ======================================================================" >> trivy_scan_report.out
                  cat "${trivy_scan_report}" >> trivy_scan_report.out
                  echo "=======================================================================================================================================================================" >> trivy_scan_report.out
                  echo "" >> trivy_scan_report.out
              fi
          done
          echo "${TOTAL_VULNERABILITIES}"
          echo "total_vulnerabilities=${TOTAL_VULNERABILITIES}" >> $GITHUB_OUTPUT

      - name: view trivy scan report
        shell: bash
        run: |
          trivy_scan_report="trivy_scan_report.out"
          if [[ -f "${trivy_scan_report}" ]]; then
              cat "${trivy_scan_report}" | (grep --color=always -E 'CRITICAL|HIGH|^' || true)
              check_vulnerabilities=$(cat "${trivy_scan_report}" | (grep "Total:" |egrep "CRITICAL|HIGH" || true))
              if [[ -n "${check_vulnerabilities}" ]]; then
                  echo "❌ $(tput -T xterm setaf 1)Images found with CRITICAL or HIGH vulnerabilities!$(tput -T xterm sgr0)"
                  exit 1
              else
                  echo "✅ $(tput -T xterm setaf 2)Images not found with CRITICAL or HIGH vulnerabilities!$(tput -T xterm sgr0)"
              fi
          fi
