name: Cloud E2E Web

on:
  schedule:
    - cron: '0 12 * * 0-4' # Runs at 3:00 UTC on Mon to Friday
    - cron: '0 12 * * 6' # Runs at 5:00 UTC on Sun
  workflow_dispatch:
    inputs:
      TEST_ENGINES:
        description: >
          Test engines:
          1.postgresql,mysql,oracle,oceanbase,damengdb,kingbase,goldendb,tdsql,vastbase,tidb,gaussdb,sqlserver,greatdb
          2.clickhouse,starrocks,doris
          3.redis,mongodb,etcd
          4.rabbitmq,kafka,rocketmq
          5.elasticsearch
          6.minio
          7.tdengine,influxdb,victoria_metrics
          8.nebula
          9.oceanbase_proxy,zookeeper
          10.loki
          11.ALL
        type: string
        required: true
        default: 'all'
      CLOUD_ENV_NAME:
        description: "The cloud env name of test (e.g. idc1) "
        type: choice
        required: true
        default: 'idc1'
        options:
          - idc1
          - idc4
      E2ETEST_BRANCH:
        description: "The e2etest branch name (e.g. main) "
        type: choice
        required: true
        default: 'release-2.0'
        options:
          - 'main'
          - 'release-2.0'
      APECD_REF:
        description: "The branch name of apecloud-cd"
        type: string
        required: false
        default: 'main'
  workflow_call:
    inputs:
      TEST_ENGINES:
        description: "The specify version of GO (e.g. postgresql,mysql)"
        type: string
        required: false
        default: 'mysql'
      CLOUD_ENV_NAME:
        description: "The cloud env name of test (e.g. dev) "
        type: string
        required: false
        default: 'idc1'
      E2ETEST_BRANCH:
        description: "The e2etest branch name (e.g. main) "
        type: string
        required: false
        default: 'release-2.0'
      APECD_REF:
        description: "The branch name of apecloud-cd"
        type: string
        required: false
        default: 'main'

run-name: Cloud E2E Web Test on IDC:${{ inputs.CLOUD_ENV_NAME }} ${{ inputs.TEST_ENGINES }} Ref:${{ inputs.E2ETEST_BRANCH }}

env:
  ACK_KUBECONFIG_DEV: ${{ secrets.ACK_KUBECONFIG_DEV }}
  ACK_KUBECONFIG_DEMO: ${{ secrets.ACK_KUBECONFIG_DEMO }}
  IDC_KUBECONFIG: ${{ secrets.IDC_KUBECONFIG }}
  IDC_KUBECONFIG_1: ${{ secrets.IDC_KUBECONFIG_1 }}
  IDC_KUBECONFIG_2: ${{ secrets.IDC_KUBECONFIG_2 }}
  IDC_KUBECONFIG_4: ${{ secrets.IDC_KUBECONFIG_4 }}
  GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}

jobs:
  get-test-engine:
    runs-on: ubuntu-latest
    outputs:
      test-engines: ${{ steps.get_test_engine.outputs.test-engines }}
      test-engines-all: ${{ steps.get_test_engine.outputs.test-engines-all }}
      e2etest-branch: ${{ steps.get_test_engine.outputs.e2etest-branch }}
      cloud-env-name: ${{ steps.get_test_engine.outputs.cloud-env-name }}
      test-date: ${{ steps.get_test_engine.outputs.test-date }}
    steps:
      - name: Get test engine
        id: get_test_engine
        run: |
          export TZ='Asia/Shanghai'
          echo "test-date=$(date +%Y%m%d)" >> $GITHUB_OUTPUT
          
          # 定义预设组
          G1="postgresql,mysql,oracle,oceanbase,damengdb,kingbase,goldendb,tdsql,vastbase,tidb,gaussdb,sqlserver,greatdb"
          G2="clickhouse,starrocks,doris"
          G3="redis,mongodb,etcd"
          G4="rabbitmq,kafka,rocketmq"
          G5="elasticsearch"
          G6="minio"
          G7="tdengine,influxdb,victoria_metrics"
          G8="nebula"
          G9="oceanbase_proxy,zookeeper"
          G10="loki"
          ALL_LIST="${G1},${G2},${G3},${G4},${G5},${G6},${G7},${G8},${G9},${G10}"
          
          # 1. 处理触发源
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
              WEEKDAY=$(date +%w) # 0=Sun, 1=Mon, ..., 5=Fri
              CLOUD_ENV="idc1"
              BRANCH="release-2.0"
          
              case $WEEKDAY in
                0) RAW_INPUT="1,2" ;; # 周日执行 1,2
                1) RAW_INPUT="3,4" ;; # 周一执行 3,4
                2) RAW_INPUT="5,6" ;; # 周二执行 5,6
                3) RAW_INPUT="7,8" ;; # 周三执行 7,8
                4) RAW_INPUT="9,10" ;; # 周四执行 9,10
                5) RAW_INPUT="all" ;; # 周五执行 ALL
                *) RAW_INPUT="1,2" ;;
              esac
          else
              RAW_INPUT="${{ inputs.TEST_ENGINES }}"
              CLOUD_ENV="${{ inputs.CLOUD_ENV_NAME }}"
              BRANCH="${{ inputs.E2ETEST_BRANCH }}"
          fi
          
          # 2. 将编号/关键字映射为实际引擎列表
          FINAL_ENGINES=""
          IFS=',' read -ra ADDR <<< "$RAW_INPUT"
          for part in "${ADDR[@]}"; do
              MAPPED=""
              case "$part" in
                "1") MAPPED=$G1 ;;
                "2") MAPPED=$G2 ;;
                "3") MAPPED=$G3 ;;
                "4") MAPPED=$G4 ;;
                "5") MAPPED=$G5 ;;
                "6") MAPPED=$G6 ;;
                "7") MAPPED=$G7 ;;
                "8") MAPPED=$G8 ;;
                "9") MAPPED=$G9 ;;
                "10") MAPPED=$G10 ;;
                "11" | "all" | "ALL") MAPPED=$ALL_LIST ;;
                *) MAPPED=$part ;; 
              esac
          
              if [[ -z "$FINAL_ENGINES" ]]; then
                  FINAL_ENGINES="$MAPPED"
              else
                  FINAL_ENGINES="$FINAL_ENGINES,$MAPPED"
              fi
          done
          
          # 3. 转换为 Matrix 结构
          test_engines=""
          test_engines_all=""
          idx=1
          for engine in $(echo "${FINAL_ENGINES}" | sed 's/,/ /g' ); do
              formatted_idx=$(printf "%02d" $idx)
              item="{\"test-engine\":\"$engine\",\"test-job-index\":\"$formatted_idx\"}"
              if [[ -z "$test_engines" ]]; then
                  test_engines="$item"
                  test_engines_all="$engine|$formatted_idx"
              else
                  test_engines="$test_engines,$item"
                  test_engines_all="$test_engines_all##$engine|$formatted_idx"
              fi
              idx=$((idx+1))
          done
          
          echo "test-engines={\"include\":[$test_engines]}" >> $GITHUB_OUTPUT
          echo "test-engines-all=$test_engines_all" >> $GITHUB_OUTPUT
          echo "cloud-env-name=$CLOUD_ENV" >> $GITHUB_OUTPUT
          echo "e2etest-branch=$BRANCH" >> $GITHUB_OUTPUT
  

  e2e-web-test:
    needs: [ get-test-engine ]
    name: ${{ matrix.test-engine }}
    strategy:
      max-parallel: 2
      fail-fast: false
      matrix: ${{ fromJSON(needs.get-test-engine.outputs.test-engines) }}
    outputs:
      test-result-1: ${{ steps.get_test_result.outputs.test-result-1 }}
      test-result-2: ${{ steps.get_test_result.outputs.test-result-2 }}
      test-result-3: ${{ steps.get_test_result.outputs.test-result-3 }}
      test-result-4: ${{ steps.get_test_result.outputs.test-result-4 }}
      test-result-5: ${{ steps.get_test_result.outputs.test-result-5 }}
      test-result-6: ${{ steps.get_test_result.outputs.test-result-6 }}
      test-result-7: ${{ steps.get_test_result.outputs.test-result-7 }}
      test-result-8: ${{ steps.get_test_result.outputs.test-result-8 }}
      test-result-9: ${{ steps.get_test_result.outputs.test-result-9 }}
      test-result-10: ${{ steps.get_test_result.outputs.test-result-10 }}
      test-result-11: ${{ steps.get_test_result.outputs.test-result-11 }}
      test-result-12: ${{ steps.get_test_result.outputs.test-result-12 }}
      test-result-13: ${{ steps.get_test_result.outputs.test-result-13 }}
      test-result-14: ${{ steps.get_test_result.outputs.test-result-14 }}
      test-result-15: ${{ steps.get_test_result.outputs.test-result-15 }}
      test-result-16: ${{ steps.get_test_result.outputs.test-result-16 }}
      test-result-17: ${{ steps.get_test_result.outputs.test-result-17 }}
      test-result-18: ${{ steps.get_test_result.outputs.test-result-18 }}
      test-result-19: ${{ steps.get_test_result.outputs.test-result-19 }}
      test-result-20: ${{ steps.get_test_result.outputs.test-result-20 }}
      test-result-21: ${{ steps.get_test_result.outputs.test-result-21 }}
      test-result-22: ${{ steps.get_test_result.outputs.test-result-22 }}
      test-result-23: ${{ steps.get_test_result.outputs.test-result-23 }}
      test-result-24: ${{ steps.get_test_result.outputs.test-result-24 }}
      test-result-25: ${{ steps.get_test_result.outputs.test-result-25 }}
      test-result-26: ${{ steps.get_test_result.outputs.test-result-26 }}
      test-result-27: ${{ steps.get_test_result.outputs.test-result-27 }}
      test-result-28: ${{ steps.get_test_result.outputs.test-result-28 }}
      test-result-29: ${{ steps.get_test_result.outputs.test-result-29 }}
      test-result-30: ${{ steps.get_test_result.outputs.test-result-30 }}
      test-result-31: ${{ steps.get_test_result.outputs.test-result-31 }}
      test-result-32: ${{ steps.get_test_result.outputs.test-result-32 }}
      test-result-33: ${{ steps.get_test_result.outputs.test-result-33 }}
      test-result-34: ${{ steps.get_test_result.outputs.test-result-34 }}
      test-result-35: ${{ steps.get_test_result.outputs.test-result-35 }}
      test-date: ${{ steps.upload_test_result.outputs.test-date }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout testinfra Code
        uses: actions/checkout@v4
        with:
          repository: apecloud/testinfra
          path: ./
          token: ${{ env.GH_TOKEN }}

      - name: Checkout apecloud-cd Code
        uses: actions/checkout@v4
        with:
          repository: apecloud/apecloud-cd
          path: ./apecloud-cd
          ref: ${{ inputs.APECD_REF }}

      - name: Configure ACK Context ${{ needs.get-test-engine.outputs.cloud-env-name }}
        id: cloud_env
        run: |
          mkdir -p $HOME/.kube
          touch $HOME/.kube/config
          CLOUD_ENV_NAME="${{ needs.get-test-engine.outputs.cloud-env-name }}"
          if [[ -z "$CLOUD_ENV_NAME" ]]; then
              CLOUD_ENV_NAME="dev"
          fi
          echo CLOUD_ENV_NAME="$CLOUD_ENV_NAME" >> $GITHUB_ENV
          
          E2E_ENV_VARS=""
          case "$CLOUD_ENV_NAME" in
              dev)
                  echo '${{ env.ACK_KUBECONFIG_DEV }}' > $HOME/.kube/config
                  E2E_ENV_VARS="${{ vars.E2E_WEB_ENV_VARS_DEV }}"
              ;;
              demo)
                  echo '${{ env.ACK_KUBECONFIG_DEMO }}' > $HOME/.kube/config
                  E2E_ENV_VARS="${{ vars.E2E_WEB_ENV_VARS_DEMO }}"
              ;;
              idc)
                  echo '${{ env.IDC_KUBECONFIG }}' > $HOME/.kube/config
                  E2E_ENV_VARS="${{ vars.E2E_WEB_ENV_VARS_IDC }}"
              ;;
              idc1)
                  echo '${{ env.IDC_KUBECONFIG_1 }}' > $HOME/.kube/config
                  E2E_ENV_VARS="${{ vars.E2E_WEB_ENV_VARS_IDC1 }}"
              ;;
              idc2)
                  echo '${{ env.IDC_KUBECONFIG_2 }}' > $HOME/.kube/config
                  E2E_ENV_VARS="${{ vars.E2E_WEB_ENV_VARS_IDC2 }}"
              ;;
              idc4)
                  echo '${{ env.IDC_KUBECONFIG_4 }}' > $HOME/.kube/config
                  E2E_ENV_VARS="${{ vars.E2E_WEB_ENV_VARS_IDC4 }}"
              ;;
          esac
          echo E2E_ENV_VARS="$E2E_ENV_VARS" >> $GITHUB_ENV

      - name: install python dateutil
        run: |
          pip3 install python-dateutil

      - name: run ${{ matrix.test-type }}
        run: |
          run_file_log="run_e2e_test_result.log"
          touch ${run_file_log} 
          
          for env_vars in $(echo "${E2E_ENV_VARS}" | sed 's/|/ /g'); do
              eval_cmd="export $env_vars"
              echo "$eval_cmd"
              eval "$eval_cmd"
          done
          
          TEST_ENGINES="${{ matrix.test-engine }}"
          TEST_JOB_INDEX="${{ matrix.test-job-index }}"
          echo "export TEST_ENGINES=${TEST_ENGINES}"
          export TEST_ENGINES=${TEST_ENGINES}
          
          TEST_BRANCH="${{ needs.get-test-engine.outputs.e2etest-branch }}"  

          # run cloud e2e web test
          bash test/cloud/test_cloud_e2e_web.sh \
              --test-type smoke \
              --pod-index "${TEST_JOB_INDEX}" \
              --release-version "${TEST_BRANCH}" | tee -a ${run_file_log}
          
          CLOUD_E2E_TEST_POD_NAME="$(cat ${run_file_log} | (grep '\[CLOUD-E2E-WEB-TEST-POD-NAME\]' || true) )"
          if [[ -n "${CLOUD_E2E_TEST_POD_NAME}" && "$CLOUD_E2E_TEST_POD_NAME" == "[CLOUD-E2E-WEB-TEST-POD-NAME]"* ]]; then
              CLOUD_E2E_TEST_POD_NAME=${CLOUD_E2E_TEST_POD_NAME#*"[CLOUD-E2E-WEB-TEST-POD-NAME]"}      
          fi
          echo CLOUD_E2E_TEST_POD_NAME="$CLOUD_E2E_TEST_POD_NAME" >> $GITHUB_ENV

      - name: Waiting for Cloud E2E Web to be Completed
        run: |
          set +e
          set -o nounset
          sleep 10
          while true; do
              if kubectl get pods -n default | grep "${CLOUD_E2E_TEST_POD_NAME}" | egrep "Completed|Error" ; then
                  echo "Cloud E2E Web Test is Done"
                  break
              fi
              if kubectl get pods -n default | grep "${CLOUD_E2E_TEST_POD_NAME}" | egrep "Running|Error" ; then
                  kubectl logs -n default ${CLOUD_E2E_TEST_POD_NAME} --tail=5
              else
                  echo "Waiting for Cloud E2E Web to be Running..."
              fi
              sleep 1
          done

      - name: Get Test Result
        if: ${{ always() }}
        id: get_test_result
        run: |
          file_log="test_result.log"
          test_file_log_path="${{ github.workspace }}/${file_log}"
          touch ${test_file_log_path}
          
          set +e
          set -o nounset
          for i in $(seq 1 10); do
              kubectl logs -n default ${CLOUD_E2E_TEST_POD_NAME} > ${test_file_log_path}
              log_ret=$?
              if [[ $log_ret -eq 0 ]]; then
                  break
              fi
              sleep 1
          done
          
          for i in $(seq 1 10); do
              kubectl delete pod -n default ${CLOUD_E2E_TEST_POD_NAME} --force
              delete_ret=$?
              if [[ $delete_ret -eq 0 ]]; then
                  break
              fi
              sleep 1
          done
          set -e

          cat ${test_file_log_path}
          test_ret="$( grep "PLAYWRIGHT TEST FAILED" ${test_file_log_path} || true )"
          TEST_RESULT_ALL="$(awk '/PLAYWRIGHT-RESULT/{found=1} found' "${test_file_log_path}" || true)"          
          
          engine_type=$(printf "%s\n" "$TEST_RESULT_ALL" | awk '
            /PLAYWRIGHT-RESULT/ {found=1; next}
            found && $1 != "" && $1 != "ENGINE_TYPE" {
              print $1; exit
            }
          ')
          
          body=$(printf "%s\n" "$TEST_RESULT_ALL" | awk -v et="$engine_type" '
              /PLAYWRIGHT-RESULT/ {start=1; next}
              start && $1 == et {
                  if (i++ > 0) printf "##"
                      printf "%s|%s", $2, $3
              }
          ')
          
          TEST_RESULT=$(printf "###%s###%s\n" "$engine_type" "$body")

          if [[ -z "$TEST_RESULT" ]]; then
              TEST_RESULT="[PASSED]"
              if [[ -n "$test_ret" || -z "${TEST_RESULT_ALL}" ]]; then
                  TEST_RESULT="[FAILED]"
              fi
              echo "test result PASSED or FAILED:${TEST_RESULT}"
          fi
          
          echo TEST_RESULT="$TEST_RESULT"
          
          if [[ -z "$TEST_RESULT" ]]; then
              TEST_RESULT=$(sed -n '/short test summary info/,$p' "${test_file_log_path}" | (egrep 'PASSED|FAILED|ERROR' | tail -n 1 || true))
          fi
          
          TEST_JOB_INDEX="${{ matrix.test-job-index }}"
          delimiter="EOF_VAR_${TEST_JOB_INDEX}"
          case "${TEST_JOB_INDEX}" in
              01)
                  echo "test-result-1<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              02)
                  echo "test-result-2<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              03)
                  echo "test-result-3<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              04)
                  echo "test-result-4<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              05)
                  echo "test-result-5<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              06)
                  echo "test-result-6<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              07)
                  echo "test-result-7<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              08)
                  echo "test-result-8<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              09)
                  echo "test-result-9<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              10)
                  echo "test-result-10<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              11)
                  echo "test-result-11<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              12)
                  echo "test-result-12<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              13)
                  echo "test-result-13<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              14)
                  echo "test-result-14<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              15)
                  echo "test-result-15<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              16)
                  echo "test-result-16<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              17)
                  echo "test-result-17<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              18)
                  echo "test-result-18<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              19)
                  echo "test-result-19<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              20)
                  echo "test-result-20<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              21)
                  echo "test-result-21<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              22)
                  echo "test-result-22<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              23)
                  echo "test-result-23<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              24)
                  echo "test-result-24<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              25)
                  echo "test-result-25<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              26)
                  echo "test-result-26<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              27)
                  echo "test-result-27<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              28)
                  echo "test-result-28<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              29)
                  echo "test-result-29<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              30)
                  echo "test-result-30<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              31)
                  echo "test-result-30<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              32)
                  echo "test-result-30<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              33)
                  echo "test-result-30<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              34)
                  echo "test-result-30<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
              35)
                  echo "test-result-30<<$delimiter" >> $GITHUB_OUTPUT
                  echo "$TEST_RESULT" >> $GITHUB_OUTPUT
                  echo "$delimiter" >> $GITHUB_OUTPUT
              ;;
          esac  
          
          if [[ -n "$test_ret" ]]; then
              exit 1
          fi
  

  send-message:
    needs: [ get-test-engine, e2e-web-test ]
    runs-on: ubuntu-latest
    if: ${{ always() }}
    steps:
      - name: Checkout apecloud-cd Code
        uses: actions/checkout@v4
        with:
          repository: apecloud/apecloud-cd
          ref: ${{ inputs.APECD_REF }}

      - name: send test result message
        run: |
          export TZ='Asia/Shanghai'
          date_ret=$(date +%Y-%m-%d-%T)
          E2ETEST_BRANCH="${{ needs.get-test-engine.outputs.e2etest-branch }}"
          CLOUD_ENV_NAME="${{ needs.get-test-engine.outputs.cloud-env-name }}"
          TEST_ENGINES_ALL="${{ needs.get-test-engine.outputs.test-engines-all }}"
          TEST_DATE=${{ needs.get-test-engine.outputs.test-date }}
          TEST_RESULT_ALL=""
          for test_engines_all in $(echo "${TEST_ENGINES_ALL}" | sed 's/##/ /g'); do
              test_engines=${test_engines_all%%|*}
              test_job_index=${test_engines_all#*|}
              case "${test_job_index}" in
                  01)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-1 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
          
                  ;;
                  02)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-2 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  03)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-3 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  04)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-4 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  05)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-5 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  06)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-6 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  07)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-7 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  08)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-8 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  09)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-9 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  10)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-10 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  11)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-11 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  12)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-12 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  13)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-13 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  14)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-14 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  15)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-15 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  16)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-16 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  17)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-17 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  18)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-18 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  19)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-19 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  20)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-20 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  21)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-21 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  22)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-22 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  23)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-23 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  24)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-24 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  25)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-25 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  26)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-26 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  27)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-27 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  28)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-28 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  29)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-29 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  30)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-30 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  31)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-31 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  32)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-32 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  33)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-33 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  34)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-34 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
                  35)
                      TEST_RESULT="${{ needs.e2e-web-test.outputs.test-result-35 }}"
                      TEST_RESULT_ALL="${TEST_RESULT_ALL}${TEST_RESULT}"
                  ;;
              esac
          done
          
          echo "TEST_RESULT_ALL:${TEST_RESULT_ALL}"
          TEST_RESULT_ALL=$( bash .github/utils/utils.sh --type 46 \
              --github-repo "${{ github.repository }}" \
              --github-token "${{ env.GH_TOKEN }}" \
              --test-result "${TEST_RESULT_ALL}" \
              --run-id "$GITHUB_RUN_ID" )
          echo "TEST_RESULT_ALL:${TEST_RESULT_ALL}"
          
          TEST_TITLE="[${E2ETEST_BRANCH}][${CLOUD_ENV_NAME}] Cloud E2E Web Test [${date_ret}]"

          python3 .github/utils/send_mesage.py \
              --send-type playwright \
              --url "${{ vars.CLOUD_E2E_WEB_BOT_WEBHOOK }}" \
              --title "$TEST_TITLE" \
              --result "${TEST_RESULT_ALL}"
